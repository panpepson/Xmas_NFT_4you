<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>mint_Xmas_NFT_4you</title>
<link rel="icon" href="favicon.ico" type="image/x-icon">
<link rel="shortcut icon" href="https://trochymiak.net/i/pep-32.png" type="image/x-icon">
 <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
<style>
    body {
        font-family: 'Share Tech', sans-serif;
        font-size: 17px;
        color: white;
        display: flex;
        justify-content: center;
        align-items: center;
        margin: 0;
        width: 100vw;
        height: 100vh;
        text-shadow: 8px 8px 10px #0000008c;
        background-color: #343a40;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='28' height='49' viewBox='0 0 28 49'%3E%3Cg fill-rule='evenodd'%3E%3Cg id='hexagons' fill='%239C92AC' fill-opacity='0.25' fill-rule='nonzero'%3E%3Cpath d='M13.99 9.25l13 7.5v15l-13 7.5L1 31.75v-15l12.99-7.5zM3 17.9v12.7l10.99 6.34 11-6.35V17.9l-11-6.34L3 17.9zM0 15l12.98-7.5V0h-2v6.35L0 12.69v2.3zm0 18.5L12.98 41v8h-2v-6.85L0 35.81v-2.3zM15 0v7.5L27.99 15H28v-2.31h-.01L17 6.35V0h-2zm0 49v-8l12.99-7.5H28v2.31h-.01L17 42.15V49h-2z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E"), linear-gradient(to right top, #343a40, #2b2c31, #211f22, #151314, #000000);
    }

    h1 {
        margin: 30px;
    }

    .mint {
        width: auto;
    }

    #saveAndOpenButton {
        display: none;
    }

    .kasa {
        margin-left: 33%;
    }
    .nft-gallery {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 20px;
        margin: 20px 0;
    }
    .nft-item {
        text-align: center;
        margin: 10px;
    }
    @media (max-width: 768px) {
        .nft-gallery {
            flex-direction: column;
            align-items: center;
        }
    }
</style>
</head>
<body>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
 <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
<center>
<div class="container">
<div class="row  justify-content-md-center">
<div class="col-md-auto"> 
<h2>ğŸ… ğŸŒ²</h2>
<h3>Tu wymintujesz edukacyjny token</h3> 
<h2> <a href="https://scan.mypinata.cloud/ipfs/bafybeih3olry3is4e4lzm7rus5l3h6zrphcal5a7ayfkhzm5oivjro2cp4/#/token/0x9DF4d4eC50132C53D5e4928F2688af26068fa096" target="_blank">Xmas_NFT_4you</a></h2>
<h4>na sieci <a href="https://www.gopulsechain.com/" target="_blank">PulsChaine</a>  jako Å›wiÄ…tecznÄ… kartkÄ™ rodziny i znajomych</h4>
<h4>Jedyny koszt ğŸ«° to opÅ‚ata za gaz - nie masz gazu na opÅ‚aty sieciowe?</h4>
<h4>Nie martw siÄ™ ğŸ˜ <a href="https://getpls.fyi/" target="_blank">Tu jest kranik   ğŸ¼ gdzie dostaniesz swoje pierwsze PLS i starczy na gaz</a></h4>    
    </div>
    <div class="col-md-auto">
    </div>
    <div class="col-md-auto">
    </div>
  </div>
</div>
<div class="container">
  <div class="row">
    <div class="col-6">
     <div class="p-3"><div id="connectButton" class="btn btn-info rounded-pill">PoÅ‚Ä…cz swÃ³j portfel z sieciÄ… PulseChain</div></div>
    </div>
    <div class="col-6">
      <div class="p-3"><div id="balance"></div></div>
    </div>
  </div>
</div>
<div id="mintButtonContainer" class="d-grid gap-2"></div>
<br>
 <div id="tokenUriDisplay"></div>
 <div id="buyInfo"></div>
 <button id="saveAndOpenButton">Zapisz token na dysku</button>
<div id="tokenIdDisplay2" class="nft-gallery"></div>
<div id="tokenIdDisplay"></div>

</center>

<script src="https://cdn.jsdelivr.net/npm/web3@1.5.2/dist/web3.min.js"></script>
  <script src="pabi.js"></script>
<script>
document.addEventListener('DOMContentLoaded', async () => {
  if (typeof window.ethereum !== 'undefined') {
    const ethereum = window.ethereum;
    try {
      await ethereum.request({ method: 'eth_requestAccounts' });
      const web3 = new Web3(ethereum);

      await ethereum.request({
        method: 'wallet_addEthereumChain',
        params: [
          {
            chainId: '0x171',
            chainName: 'PulseChain',
            rpcUrls: ['https://rpc.pulsechain.com'],
            nativeCurrency: {
              name: 'PLS',
              symbol: 'PLS',
              decimals: 18,
            },
            blockExplorerUrls: ['https://otter.pulsechain.com'],
          },
        ],
      });

      const networkId = await web3.eth.getChainId(); 
      if (networkId !== 369) {
        console.warn('NieprawidÅ‚owa sieÄ‡! Spodziewana PulseChain.');
        return;
      }
      const contractAddress = '0x9DF4d4eC50132C53D5e4928F2688af26068fa096';
      const contract = new web3.eth.Contract(contractABI, contractAddress);
      const accounts = await web3.eth.getAccounts();
      const userAddress = accounts[0];
      document.getElementById('connectButton').innerHTML = `JesteÅ› zalogowany jako: <br><b>${userAddress}</b>`;
      const balance = await web3.eth.getBalance(userAddress);
      const formattedBalance = (web3.utils.fromWei(balance, 'ether') * 1).toFixed(2);
      document.getElementById('balance').innerHTML = `<p class="rounded-pill bg-success kasa" >Saldo konta to : <br><b>${formattedBalance}</b> PLS</p>`;
 try {
    const numMinted = await contract.methods.numMinted().call();
    const userAddress = accounts[0];
    const nftBalance = await contract.methods.balanceOf(userAddress).call();
        
    let nftDisplay = `<center><h4>Posiadasz ${nftBalance} z ${numMinted} caÅ‚kowicie wymintowanych tokenÃ³w NFT</h4><div class="nft-gallery">`;

    for (let i = 0; i < numMinted+1; i++) {
       try {
            const adresId = await contract.methods.ownerOf(i).call();
        if(adresId === userAddress){
                for(let aa = 0; aa < nftBalance; aa++){
//    console.log(adresId + ' / ' + i);
        } 
           const tokenId = i;   
            const tokenUri = await contract.methods.tokenURI(i).call();
            
            let imageUrl = tokenUri;
            let tokenName = `NFT #${tokenId}`;
          if (tokenUri.startsWith('data:application/json;base64,')) {
                try {
                    const base64Data = tokenUri.split(',')[1];
                    const jsonMetadata = JSON.parse(atob(base64Data));
                    imageUrl = jsonMetadata.image || imageUrl;
                    animation_url = jsonMetadata.animation_url || '';
                    tokenName = jsonMetadata.name || tokenName;
                } catch (error) {
                    console.error('BÅ‚Ä…d dekodowania metadanych:', error);
                }
            }
            
  nftDisplay += `
    <div class="nft-item">
        <a href="#" onclick="openAnimation('${animation_url}')" alt="${tokenName}">
            <img src="${imageUrl}" alt="${tokenName}" class="img-thumbnail" width="200">
        </a>
        <p class="nft-title">${tokenName}</p>
        <p class="nft-id">Token ID: ${tokenId}</p>
    </div>`;

         }

        } catch (error) {
            //console.error(`BÅ‚Ä…d podczas pobierania tokenu ${i}:`, error);
       }

    }

    nftDisplay += '</div></center>';

    if (nftBalance == 0) {
        nftDisplay = '<h4>Nie posiadasz Å¼adnych NFT z tej kolekcji</h4>';
    }
    document.getElementById('tokenIdDisplay2').innerHTML = nftDisplay;

} catch (error) {
    console.error('BÅ‚Ä…d podczas pobierania NFT:', error);
    document.getElementById('tokenIdDisplay2').innerHTML = 'WystÄ…piÅ‚ bÅ‚Ä…d podczas Å‚adowania NFT.';
}

      // Pobieranie liczby wyemitowanych NFT
      const numMinted = await contract.methods.numMinted().call();
      const userNFTBalance = await contract.methods.balanceOf(userAddress).call();

      if (numMinted >= 12) {
        document.getElementById('buyInfo').innerHTML = '<b>Bida ğŸ¤” ziom, spÃ³ÅºniÅ‚eÅ› siÄ™</b> teraz juÅ¼ tylko moÅ¼esz zdobyÄ‡ juÅ¼ wymintowane <b>Xmas_NFT_4you</b> na <a href="https://pulsemarket.app/collection/0x9DF4d4eC50132C53D5e4928F2688af26068fa096">https://pulsemarket.app</a>';
      } else if (userNFTBalance >= 12) {
        document.getElementById('buyInfo').innerHTML = `<br><br><h2> ğŸ§…  Masz juÅ¼ ğŸ§…  12 sztuk <b>Xmas_NFT_4you</b>, wiÄ™c daj szansÄ™ innym ğŸ«²ğŸ˜ğŸ«±</h2> <br>WiÄ™cej INFO dot kontraktu znajdziesz tu <a href="https://otter.pulsechain.com/address/address/${contractAddress}" target="_blank">${contractAddress}</a>`;
      } else {
        document.getElementById('mintButtonContainer').innerHTML = '<button id="mintButton" type="button" class="btn btn-primary bg-dark rounded-pill mint"><h1>Mintuj Xmas_NFT_4you</h1></button>';

        document.getElementById('mintButton').addEventListener('click', async () => {
          try {
            const cena = web3.utils.toWei('21');
            const result = await contract.methods.mint(cena).send({ from: userAddress });
            console.log('Transakcja udana:', result);
          
            const event = result.events?.Transfer;
            if (!event) {
              console.error('Brak eventu Transfer. SprawdÅº logi:', result);
              return;
            }
       const tokenId = event.returnValues?.tokenId;
   document.getElementById('tokenIdDisplay').innerHTML = `<center>
              <br><h2> OK udaÅ‚o siÄ™ ğŸ‘ğŸ¤  masz juÅ¼ token o numerze ${tokenId} ğŸ˜</h2><br>
              <h3>Oto <b>Instrukcje</b> jak dodaÄ‡ token do portfela:</h3>
              OtwÃ³rz np. MetaMask w swojej przeglÄ…darce.<br>
              Kliknij na ikonÄ™ MetaMask ğŸ¦Š na pasku przeglÄ…darki.<br>
              Wybierz zakÅ‚adkÄ™ <b>"NFTs"</b> i na dole <br>
              Kliknij <b>"+ Importuj NFT"</b><br><br>
              WprowadÅº Adres kontraktu: <b>${contractAddress}</b><br>
              Token ID: <b>${tokenId}</b></center>`;
    Confetti();
          } catch (error) {
            console.error('BÅ‚Ä…d podczas mintowania:', error);
          }
        });
      }
    } catch (error) {
      console.error('BÅ‚Ä…d podczas Å‚Ä…czenia:', error);
    }
  } else {
    alert('Zainstaluj MetaMask, aby poÅ‚Ä…czyÄ‡ siÄ™ z PulseChain.');
  }
});

function openAnimation(animation_url) {
    if (animation_url.startsWith('data:text/html;base64,')) {
        const newTab = window.open();
        newTab.document.write(atob(animation_url.split(',')[1])); 
        newTab.document.close();
    } else {
        window.open(animation_url, '_blank');
    }
}

 function Confetti(){ confetti({ particleCount: 250, spread: 80, origin: { y: 0.6 }}); }


</script>
</body>
</html>
